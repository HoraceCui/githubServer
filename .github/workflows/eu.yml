# This is a basic workflow to help you get started with Actions

name: eu

on:
  workflow_dispatch:
    inputs:
      ssh_user:
        description: 'è¿œç¨‹æœåŠ¡å™¨ç”¨æˆ·åï¼ˆé»˜è®¤ rootï¼‰'
        required: false
        default: 'root'
      ssh_port:
        description: 'SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼‰'
        required: false
        default: '22'
      new_username:
        description: 'è¦åˆ›å»ºçš„æ–°ç”¨æˆ·å'
        required: true
      ssh_password:
        description: 'è¿œç¨‹ç”¨æˆ·å¯†ç '
        required: true

jobs:
  remote-ssh:
    runs-on: ubuntu-latest

    steps:
    - name: âœ… Checkout this repository
      uses: actions/checkout@v3

    - name: ğŸš€ SSH into remote server and run scripts
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.eu }}
        username: ${{ github.event.inputs.ssh_user }}
        password: ${{ github.event.inputs.ssh_password }}
        port: ${{ github.event.inputs.ssh_port }}
        script: |
          set -e
          echo "ğŸ“ åˆ‡æ¢åˆ°ä»“åº“ç›®å½•..."
          echo GITHUB_WORKSPACE
          cd ${GITHUB_WORKSPACE}/eu
          pwd
          ls -al
          cd ~/githubServer || {
            echo "ğŸ“¥ å…‹éš†ä»“åº“..."
            git clone https://github.com/${{ github.repository }} ~/githubServer
            cd ~/githubServer/eu
          }

          echo "ğŸ‘¤ æ‰§è¡Œç”¨æˆ·åˆ›å»ºè„šæœ¬..."
          bash addUser.sh ${{ github.event.inputs.new_username }}

          echo "ğŸ” æ‰§è¡Œ SSH åŠ å›ºè„šæœ¬..."
          bash harden_ssh.sh ${{ github.event.inputs.ssh_port }}